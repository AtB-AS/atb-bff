# AtB BFF (oneclick-journey-planner)

Provides HTTP REST endpoints for consuming Entur services from mobile / web
applications. Built as a docker image and runs on GCP.

API documentation is generated at runtime and lives in `/documentation`
(Swagger).

## Installation

Clone this project:

`git clone https://github.com/atb-as/atb-bff.git`

### Docker

Build and run the docker image, for local development:

```
docker build --target=dev -t atb-bff:dev .
docker run --rm -it -e PORT=8080 -p 8080:8080 -v $PWD:/app atb-bff:dev
```

### Starting locally

#### Requirements

- Node.js

Install node packages

`npm install`

Start the development server

`npm run start:dev`

#### Potential errors
##### Unable to detect project-id
When attempting `npm run start:dev` you might encounter the error: 
`failed to initialize server: Unable to detect a Project Id in the current environment.`

If this happens, running `gcloud auth login` have previously set project id after successful authentication. 

## Architecture

The runtime is written in TypeScript and runs on Node.js

- HTTP server framework: [Hapi](https://hapi.dev)
  - Request and response validation is performed by
    [Joi](https://hapi.dev/family/joi/)
  - Swagger documentation is generated by
    [hapi-swagger](https://github.com/glennjones/hapi-swagger)
- Testing framework: [Jest](https://jestjs.io/)

Hapi was chosen because it is battle-tested, has a magnitude of features
supported out of the box, and has few external dependencies. Most of its
dependencies are handled by the same team that maintains Hapi.

Service interfaces lives in `service/`, implementations in `service/impl`

API endpoints live in `api/`.

The current implementation uses [@entur/sdk](https://github.com/entur/sdk) as an
abstraction on top of Entur's GraphQL endpoints.

## GraphQL Code Generation

For endpoints that uses GraphQL directly we generate types and code using
`graphql-code-gen`.

JP2 and JP3 queries must be put in folders named jp2 and jp3 respectively for
the scripts to know which API version to use.

If the queries, scheme, operations or fragments change, generate the code using
scripts:

```
npm run gql-gen
```

for Journeyplanner v2 API or

```
npm run gql-gen-v3
```

for Journeyplanner v3 API.

This will make a TypeScript representation of the `.graphql` file in the same
location but with `.graphql-gen.ts` extension. You can use these directly as
queries.

## Deploy to staging
GCP will pick up and deploy new versions of BFF automatically, but the API Gateway will not.
The API gateway needs the swagger configuration for any new or changed endpoints from the BFF build.
go to GCP and make sure you are in the atb-mobility-platform-staging project.
find Cloud build / Triggers, and hit RUN on the trigger called "amp-api-gateway"

## Deploy to prod
GCP will automatically build the `prod` branch on push.
When `prod` build is success, `api-gateway` will automatically trigger and make changes available to the world.
Take special note of the `host` field in the `swagger.yaml` file, this field is different for master (local/staging) and prod branches.
marges to `prod` must have the correct `host` field, so make sure this field is <u>not</u> merged from `master`, but is kept as is.


